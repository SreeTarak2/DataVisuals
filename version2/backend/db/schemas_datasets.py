"""
Dataset Schemas (Core)
----------------------
These schemas define the contracts for:
- Dataset metadata & profiling
- Column-level summaries
- File storage structures
- Paginated dataset responses
- Upload responses

This module is ONLY for dataset-related functionality.
"""

from pydantic import BaseModel, Field
from typing import List, Dict, Any, Optional
from datetime import datetime


# ---------------------------------------------------
# Base Config
# ---------------------------------------------------
class _Config:
    orm_mode = True
    extra = "forbid"
    arbitrary_types_allowed = True


# ---------------------------------------------------
# Dataset Overview & Metadata
# ---------------------------------------------------
class DatasetInfo(BaseModel):
    """Basic info about a processed dataset."""
    id: str
    filename: str
    total_rows: int
    total_columns: int
    columns: List[str]
    uploaded_at: str

    class Config(_Config):
        pass


class DatasetMetadata(BaseModel):
    """
    Full metadata generated by your profiling pipeline.
    Includes:
    - overview stats
    - column-level metadata
    - correlations & summaries
    - data quality report
    """
    dataset_overview: Dict[str, Any]
    column_metadata: List[Dict[str, Any]]
    statistical_summaries: Dict[str, Any]
    data_quality: Dict[str, Any]
    chart_recommendations: List[Dict[str, Any]]
    hierarchies: List[Dict[str, Any]]

    class Config(_Config):
        pass


# ---------------------------------------------------
# Dataset Preview, Pagination & Summary
# ---------------------------------------------------
class DatasetData(BaseModel):
    """Paginated dataset rows."""
    data: List[Dict[str, Any]]
    total_rows: int
    current_page: int
    page_size: int
    has_more: bool

    class Config(_Config):
        pass


class DatasetSummary(BaseModel):
    """High-level summary from profiling service."""
    total_rows: int
    total_columns: int
    numeric_columns: List[str]
    categorical_columns: List[str]
    missing_values: Dict[str, int]
    data_types: Dict[str, str]
    basic_stats: Optional[Dict[str, Any]] = None

    class Config(_Config):
        pass


# ---------------------------------------------------
# File-Based Dataset Entries
# ---------------------------------------------------
class DatasetFileInfo(BaseModel):
    """Represents a file stored in disk or DB."""
    file_id: str
    original_filename: str
    file_path: str
    file_size: int
    storage_type: str               # "database" or "file"
    upload_date: datetime

    class Config(_Config):
        pass


class DatasetCreate(BaseModel):
    """Payload for creating DB record for an uploaded file."""
    name: str
    description: Optional[str] = None
    file_id: str
    original_filename: str
    file_size: int
    storage_type: str

    class Config(_Config):
        pass


class DatasetFile(DatasetFileInfo):
    """
    Full dataset DB record.
    Includes:
    - file metadata
    - extracted schema
    - preview/sample rows
    - processing status
    """
    id: str
    user_id: str
    name: str
    description: Optional[str] = None

    columns: Optional[List[str]] = None
    data_types: Optional[Dict[str, str]] = None

    row_count: Optional[int] = None
    column_count: Optional[int] = None

    preview_data: Optional[List[Dict[str, Any]]] = None
    sample_data: Optional[List[Dict[str, Any]]] = None

    last_accessed: Optional[datetime] = None
    is_processed: bool = False

    class Config(_Config):
        pass


# ---------------------------------------------------
# Upload Response Schema
# ---------------------------------------------------
class UploadResponse(BaseModel):
    """Return after a dataset upload + processing."""
    dataset_id: str
    message: str
    metadata: DatasetMetadata

    class Config(_Config):
        pass


# ---------------------------------------------------
# Export
# ---------------------------------------------------
__all__ = [
    "DatasetInfo",
    "DatasetMetadata",
    "DatasetData",
    "DatasetFileInfo",
    "DatasetCreate",
    "DatasetFile",
    "DatasetSummary",
    "UploadResponse",
]
